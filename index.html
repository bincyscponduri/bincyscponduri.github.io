<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ludo Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Layout */
        body {
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Board */
        .ludo-board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            width: 95vw; height: 95vw;
            max-width: 65vh; max-height: 65vh; 
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 4px solid white;
            z-index: 10;
        }
        @media (min-width: 768px) {
            .ludo-board { width: 75vh; height: 75vh; max-width: 600px; max-height: 600px; }
        }

        .cell { border: 1px solid #e2e8f0; position: relative; display: flex; align-items: center; justify-content: center; overflow: visible; min-width: 0; min-height: 0; }

        /* Bases */
        .base { grid-row: span 6; grid-column: span 6; padding: 12%; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15%; position: relative; border-radius: 4px; transition: all 0.3s; }
        
        .base.left-game { filter: grayscale(100%); opacity: 0.5; }
        .base.left-game::after { content: 'LEFT'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 2rem; font-weight: 900; color: #475569; opacity: 0.8; }
        
        .base-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; font-weight: 900; color: rgba(0,0,0,0.3); pointer-events: none; text-transform: uppercase; z-index: 0; letter-spacing: 1px; text-align: center; width: 100%; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
        
        .base-red { background: linear-gradient(145deg, #fca5a5, #ef4444); border: 1px solid #b91c1c; }
        .base-green { background: linear-gradient(145deg, #86efac, #22c55e); border: 1px solid #15803d; }
        .base-blue { background: linear-gradient(145deg, #93c5fd, #3b82f6); border: 1px solid #1d4ed8; }
        .base-yellow { background: linear-gradient(145deg, #fde047, #eab308); border: 1px solid #a16207; }
        
        .base-inner { background: white; border-radius: 50%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); z-index: 1; }

        /* Path Colors */
        .path-red { background-color: #ef4444; } .path-green { background-color: #22c55e; } .path-blue { background-color: #3b82f6; } .path-yellow { background-color: #eab308; }
        .safe-spot::after { content: '\f005'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: rgba(0,0,0,0.2); font-size: 0.75rem; position: absolute; z-index: 0; }
        .start-point { background-image: radial-gradient(circle, rgba(0,0,0,0.15) 25%, transparent 25%); background-size: 100% 100%; }

        /* Center Box */
        .center-box { grid-column: 7 / span 3; grid-row: 7 / span 3; display: grid; grid-template-areas: "g g y" "r x y" "r b b"; z-index: 1; background: radial-gradient(circle, #fffbeb 0%, #fcd34d 100%); box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.5); position: relative; }
        .center-box::after { content: '\f091'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: rgba(255, 255, 255, 0.6); z-index: 5; pointer-events: none; }
        .tri-red { grid-area: r; background: transparent; clip-path: polygon(0 0, 100% 50%, 0 100%); border-right: 1px solid rgba(0,0,0,0.1); background-color: rgba(239, 68, 68, 0.2); }
        .tri-green { grid-area: g; background: transparent; clip-path: polygon(0 0, 100% 0, 50% 100%); border-bottom: 1px solid rgba(0,0,0,0.1); background-color: rgba(34, 197, 94, 0.2); }
        .tri-yellow { grid-area: y; background: transparent; clip-path: polygon(100% 0, 100% 100%, 0 50%); border-left: 1px solid rgba(0,0,0,0.1); background-color: rgba(234, 179, 8, 0.2); }
        .tri-blue { grid-area: b; background: transparent; clip-path: polygon(50% 0, 0 100%, 100% 100%); border-top: 1px solid rgba(0,0,0,0.1); background-color: rgba(59, 130, 246, 0.2); }

        /* Tokens */
        .token { width: 65%; height: 65%; justify-self: center; align-self: center; z-index: 50; cursor: default; display: flex; align-items: center; justify-content: center; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 0; min-height: 0; }
        .token.moveable { cursor: pointer; z-index: 60; }
        .token svg { width: 100%; height: 100%; stroke: white; stroke-width: 30px; paint-order: stroke; overflow: visible;}
        .token-red { color: #dc2626; } .token-green { color: #16a34a; } .token-blue { color: #2563eb; } .token-yellow { color: #ca8a04; }
        .highlight-move { animation: pulse-highlight 1.5s infinite; }
        @keyframes pulse-highlight { 0% { transform: scale(1) translateY(-15%); filter: brightness(1) drop-shadow(0 2px 2px rgba(0,0,0,0.5)); } 50% { transform: scale(1.25) translateY(-25%); filter: brightness(1.2) drop-shadow(0 6px 6px rgba(0,0,0,0.2)); } 100% { transform: scale(1) translateY(-15%); filter: brightness(1) drop-shadow(0 2px 2px rgba(0,0,0,0.5)); } }

        /* Dice */
        .dice-box { width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; transition: transform 0.1s; background: white; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); color: #334155; position: relative; opacity: 1 !important; }
        .dice-rolling { animation: chaos-roll 0.4s linear infinite; }
        @keyframes chaos-roll { 0% { transform: rotate3d(1,1,1,0deg); } 100% { transform: rotate3d(1,1,1,360deg); } }
        .dice-red { color: #ef4444; border: 2px solid #fee2e2; } .dice-green { color: #22c55e; border: 2px solid #dcfce7; } .dice-yellow { color: #eab308; border: 2px solid #fef9c3; } .dice-blue { color: #3b82f6; border: 2px solid #dbeafe; }

        /* Floating Chat */
        #floating-chat-container { position: absolute; bottom: 120px; left: 20px; width: 300px; max-width: 70%; z-index: 100; display: flex; flex-direction: column; align-items: flex-start; pointer-events: none; }
        .chat-bubble-float { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border: 1px solid white; color: #334155; padding: 10px 16px; border-radius: 18px; border-bottom-left-radius: 4px; margin-top: 8px; font-size: 0.95rem; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px) scale(0.9); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, fadeOut 0.5s 5.5s forwards; pointer-events: auto; }
        .chat-bubble-float strong { color: #64748b; text-transform: uppercase; font-size: 0.7rem; display: block; margin-bottom: 2px; }
        @keyframes popIn { to { opacity: 1; transform: translateY(0) scale(1); } } @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px) scale(0.95); } }

        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .hidden { display: none !important; }
        .btn-glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.5); transition: all 0.2s; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        
        .footer-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
            margin-bottom: 0;
            background: rgba(255,255,255,0.95);
        }
        
        /* Audio Indicators */
        .speaking-indicator { box-shadow: 0 0 0 3px #22c55e !important; }
    </style>
</head>
<body class="text-slate-700">

    <div id="remote-audio-container" class="hidden"></div>

    <div id="auth-screen" class="fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 bg-gradient-to-br from-indigo-50 to-blue-100">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-sm text-center shadow-xl">
            <div class="text-5xl mb-4">üé≤</div>
            <h1 class="text-3xl font-black text-slate-800 mb-6">Ludo Master</h1>
            <div class="space-y-3">
                <input type="text" id="login-username" class="w-full p-3 bg-white/50 border border-white rounded-xl outline-none focus:ring-2 focus:ring-indigo-300 transition-all font-bold text-slate-700" placeholder="Username">
                <input type="password" id="login-password" class="w-full p-3 bg-white/50 border border-white rounded-xl outline-none focus:ring-2 focus:ring-indigo-300 transition-all font-bold text-slate-700" placeholder="Password">
                <button onclick="window.attemptLogin()" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-transform active:scale-95">Play Now</button>
            </div>
            <div class="mt-6">
                <button onclick="window.skipLogin()" class="text-sm text-indigo-500 hover:text-indigo-700 font-bold">Play as Guest</button>
            </div>
        </div>
    </div>

    <div id="main-menu" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-50 to-slate-200">
        <div class="glass-panel p-8 rounded-3xl max-w-md w-full text-center">
            <h1 class="text-4xl font-black text-slate-800 mb-2 tracking-tight">Ludo Master</h1>
            <p class="text-slate-500 mb-6">Logged in as <span id="display-username" class="font-bold text-indigo-600">User</span></p>
            <div class="space-y-4">
                <button onclick="window.startGame('local')" class="w-full py-4 px-6 bg-slate-800 hover:bg-slate-900 text-white rounded-2xl font-bold shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-3"><i class="fas fa-robot text-blue-300"></i> VS Smart AI</button>
                <button onclick="window.showOnlineMenu()" class="w-full py-4 px-6 bg-white hover:bg-slate-50 text-slate-800 border-2 border-slate-100 rounded-2xl font-bold shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-3"><i class="fas fa-globe text-green-500"></i> Online Multiplayer</button>
                <button onclick="window.logout()" class="w-full py-2 text-sm text-red-400 hover:text-red-600 font-bold mt-4">Logout</button>
            </div>
        </div>
    </div>

    <div id="online-menu" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-slate-100/90 backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-3xl max-w-md w-full space-y-6">
            <div class="flex items-center justify-between"><h2 class="text-2xl font-bold">Online Lobby</h2><button onclick="window.backToMain()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div>
            <div class="space-y-4">
                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100 text-center">
                    <p class="text-xs font-bold text-indigo-400 uppercase">Playing As</p>
                    <p class="text-lg font-black text-indigo-700 mt-1" id="online-player-name">Player</p>
                </div>
                <button onclick="window.createRoom()" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">Create New Room</button>
                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div><div class="relative flex justify-center text-xs font-bold text-slate-400 uppercase bg-white px-2">Or</div></div>
                <div class="flex gap-2"><input type="text" id="room-code-input" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl uppercase font-mono font-bold tracking-widest text-center" placeholder="CODE"><button onclick="window.joinRoom()" class="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900">Join</button></div>
            </div>
        </div>
    </div>

    <div id="lobby-waiting" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-white/95">
        <div class="text-center max-w-sm w-full space-y-6">
            <div class="inline-block p-4 bg-indigo-50 rounded-2xl mb-4 relative">
                <div class="text-xs font-bold text-indigo-400 uppercase mb-1">Room Code</div>
                <div class="text-5xl font-mono font-black text-indigo-600 tracking-wider" id="display-room-code">...</div>
                <button onclick="window.copyRoomLink()" class="absolute -right-12 top-1/2 transform -translate-y-1/2 bg-slate-200 hover:bg-slate-300 text-slate-600 p-2 rounded-lg text-xs font-bold" title="Copy Link"><i class="fas fa-link"></i></button>
            </div>
            <div id="lobby-players" class="space-y-3"></div>
            <div class="flex gap-3 pt-8"><button onclick="window.exitGame()" class="flex-1 py-3 border-2 border-slate-200 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Leave</button><button id="start-online-btn" onclick="window.startOnlineGame()" class="flex-1 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 hidden">Start Game</button></div>
            <p id="waiting-msg" class="text-sm font-bold text-slate-400 animate-pulse mt-4">Waiting for host to start...</p>
        </div>
    </div>

    <div id="game-ui" class="hidden flex-col h-full w-full">
        <div class="flex-none flex justify-between items-center px-3 py-1 bg-white/80 backdrop-blur-md border-b border-slate-200/50 z-20 h-12">
            <div class="flex items-center gap-3">
                <div id="current-turn-indicator" class="w-3 h-3 rounded-full bg-slate-300 shadow-sm transition-all duration-300"></div>
                <span id="turn-text" class="font-bold text-slate-700 text-sm">Initializing...</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.toggleSFX()" id="btn-sfx" class="btn-glass w-8 h-8 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-music"></i></button>
                <button onclick="window.toggleSpeaker()" id="btn-speaker" class="btn-glass w-8 h-8 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-volume-up"></i></button>
                <button onclick="window.toggleMic()" id="btn-mic" class="btn-glass w-8 h-8 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-microphone-slash"></i></button>
                <button onclick="window.showGiveUp()" class="btn-glass w-8 h-8 rounded-full flex items-center justify-center text-red-500 hover:bg-red-50 text-xs"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center overflow-hidden w-full relative bg-slate-50/50">
            <div id="floating-chat-container"></div>
            <div class="ludo-board relative" id="board">
                <div id="base-0" class="base base-red" style="grid-row: 10/16; grid-column: 1/7;"><div class="base-label text-red-900/40" id="name-0">P1</div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div></div>
                <div id="base-1" class="base base-green" style="grid-row: 1/7; grid-column: 1/7;"><div class="base-label text-green-900/40" id="name-1">P2</div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div></div>
                <div id="base-2" class="base base-yellow" style="grid-row: 1/7; grid-column: 10/16;"><div class="base-label text-yellow-900/40" id="name-2">P3</div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div></div>
                <div id="base-3" class="base base-blue" style="grid-row: 10/16; grid-column: 10/16;"><div class="base-label text-blue-900/40" id="name-3">P4</div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div><div class="base-inner"></div></div>
                <div class="center-box"><div class="tri-green"></div><div class="tri-yellow"></div><div class="tri-red"></div><div class="tri-blue"></div></div>
            </div>
        </div>

        <div class="footer-safe flex-none border-t border-slate-200 p-2 flex items-center gap-3 z-30 shadow-[0_-4px_6px_rgba(0,0,0,0.02)]">
            <div class="flex-none w-20 flex items-center justify-center border-r border-slate-100 pr-2">
                <div id="dice-visual" class="dice-box" onclick="window.attemptRoll()">
                    <i class="fas fa-dice-six"></i>
                </div>
            </div>
            <div class="flex-1 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-slate-100 border-0 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-slate-200 transition-all font-medium" placeholder="Chat here..." onkeypress="window.handleChatKey(event)">
                <button onclick="window.sendChat()" class="bg-slate-800 text-white rounded-xl px-4 py-2 text-sm font-bold hover:bg-slate-700 transition-colors shadow-md shadow-slate-200">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="give-up-modal" class="hidden modal">
        <div class="bg-white p-6 rounded-3xl shadow-2xl text-center max-w-xs mx-4 scale-100">
            <h3 class="text-xl font-black text-slate-800 mb-1">Leave Game?</h3>
            <p class="text-slate-500 mb-6 text-sm font-medium">You will be removed from this match.</p>
            <div class="flex gap-3"><button onclick="document.getElementById('give-up-modal').classList.add('hidden')" class="flex-1 py-3 border-2 border-slate-100 rounded-xl font-bold text-slate-600 hover:bg-slate-50">Cancel</button><button onclick="window.confirmGiveUp()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-600">Leave</button></div>
        </div>
    </div>
    <div id="victory-modal" class="hidden modal">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 animate-bounce-in">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 id="winner-name" class="text-3xl font-black text-slate-800 mb-6">Red Wins!</h2>
            <button onclick="window.exitGame()" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-xl hover:bg-slate-900 transition-transform hover:scale-105">Back to Menu</button>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-2.5 rounded-full text-xs font-bold opacity-0 transition-all pointer-events-none z-[60] shadow-xl whitespace-nowrap translate-y-4"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion, collection, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDyftShVByBykSgDi6loVFgu76loF7Ey-M",
    authDomain: "website-ca551.firebaseapp.com",
    projectId: "website-ca551",
    storageBucket: "website-ca551.firebasestorage.app",
    messagingSenderId: "568567638349",
    appId: "1:568567638349:web:ec4a76d980b76b70196f04",
    measurementId: "G-3FMMQYLJK0"
};

const COLORS = ['red', 'green', 'yellow', 'blue'];
const SAFE_SPOTS = [9, 22, 35, 48];
const START_INDICES = { red: 1, green: 14, yellow: 27, blue: 40 };
const BASE_POSITIONS = {
    red: [[11,2], [11,5], [14,2], [14,5]], green: [[2,2], [2,5], [5,2], [5,5]],
    yellow: [[2,11], [2,14], [5,11], [5,14]], blue: [[11,11], [11,14], [14,11], [14,14]]
};
const MAIN_PATH = [
    [15,7],[14,7],[13,7],[12,7],[11,7],[10,7], [9,6],[9,5],[9,4],[9,3],[9,2],[9,1], [8,1],
    [7,1],[7,2],[7,3],[7,4],[7,5],[7,6], [6,7],[5,7],[4,7],[3,7],[2,7],[1,7], [1,8],
    [1,9],[2,9],[3,9],[4,9],[5,9],[6,9], [7,10],[7,11],[7,12],[7,13],[7,14],[7,15], [8,15],
    [9,15],[9,14],[9,13],[9,12],[9,11],[9,10], [10,9],[11,9],[12,9],[13,9],[14,9],[15,9], [15,8]
]; 
const HOME_PATHS = {
    red: [[14,8],[13,8],[12,8],[11,8],[10,8]], green: [[8,2],[8,3],[8,4],[8,5],[8,6]],
    yellow: [[2,8],[3,8],[4,8],[5,8],[6,8]], blue: [[8,14],[8,13],[8,12],[8,11],[8,10]]
};
const WIN_POSITIONS = { red: [9,8], green: [8,7], yellow: [7,8], blue: [8,9] };
const PAWN_SVG = `<svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>`;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myPlayerId = null, roomId = null, roomUnsubscribe = null, signalUnsubscribe = null;
let currentUser = { name: 'Player', password: '' };
let sfxEnabled = true;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// --- WEBRTC GLOBALS ---
let localStream = null;
let peerConnections = {}; // { targetUserId: RTCPeerConnection }
const rtcConfig = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // Public STUN server
};
let isMicOn = false;
let isSpeakerOn = true;

const playSound = (type) => {
    if(!sfxEnabled) return;
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'roll') { osc.frequency.setValueAtTime(400,now); osc.frequency.exponentialRampToValueAtTime(100,now+0.1); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
        else if (type === 'move') { osc.frequency.setValueAtTime(600,now); gain.gain.setValueAtTime(0.1,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
        else if (type === 'turn') { osc.frequency.setValueAtTime(800,now); gain.gain.setValueAtTime(0.2,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.3); osc.start(now); osc.stop(now+0.3); }
        else if (type === 'win') { osc.type='square'; osc.frequency.setValueAtTime(400,now); osc.frequency.linearRampToValueAtTime(800,now+0.2); gain.gain.linearRampToValueAtTime(0,now+0.5); osc.start(now); osc.stop(now+0.5); }
    } catch(e){}
};

function showScreen(screenId) {
    ['auth-screen', 'main-menu', 'online-menu', 'lobby-waiting', 'game-ui', 'give-up-modal', 'victory-modal'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(screenId).classList.remove('hidden');
    if(screenId === 'game-ui') document.getElementById('game-ui').classList.add('flex');
    else document.getElementById('game-ui').classList.remove('flex');
}

window.toggleSFX = () => { sfxEnabled = !sfxEnabled; document.querySelector('#btn-sfx i').className = sfxEnabled ? 'fas fa-music' : 'fas fa-slash text-red-400'; showToast(`SFX ${sfxEnabled?'On':'Off'}`); };

async function initAuth() {
    try {
        const saved = localStorage.getItem('ludo_user');
        if(saved) {
            currentUser = JSON.parse(saved);
            loginSuccess(currentUser.name, currentUser.password, true);
        }
        await signInAnonymously(auth);

        const params = new URLSearchParams(window.location.search);
        const linkRoom = params.get('room');
        if(linkRoom) {
            document.getElementById('room-code-input').value = linkRoom;
            if(saved) setTimeout(() => window.joinRoom(), 500);
            return; 
        }

        const activeRoom = localStorage.getItem('ludo_current_room');
        if(activeRoom && saved) rejoinSession(activeRoom);
    } catch(e) { console.error("Auth Init:", e); }
}

async function rejoinSession(code) {
    if(!auth.currentUser) await signInAnonymously(auth);
    myPlayerId = auth.currentUser.uid;
    roomId = code;
    const ref = doc(db, 'ludo_rooms', code);
    const d = await getDoc(ref);
    if(d.exists()) {
        const players = d.data().players;
        if(players.some(p => p.id === myPlayerId && p.status !== 'left')) {
            showToast("Rejoining Game...");
            enterLobby(code);
            initWebRTC(); // Re-init audio listener
        } else {
            localStorage.removeItem('ludo_current_room');
        }
    }
}

initAuth();
onAuthStateChanged(auth, u => { if(u) myPlayerId = u.uid; });

let gameState = { mode: 'local', turn: 0, diceValue: 0, waitingForMove: false, isProcessing: false, players: [], pieces: [], winners: [] };
gameState.chatCount = 0;

window.attemptLogin = async () => {
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value.trim();
    if(!u || !p) return showToast("Enter details");
    if(!auth.currentUser) await signInAnonymously(auth);
    try {
        const ref = doc(db, 'ludo_users', u);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            if(snap.data().password === p) loginSuccess(u, p); else showToast("Wrong Password");
        } else {
            await setDoc(ref, { password: p, created: serverTimestamp() });
            loginSuccess(u, p);
        }
    } catch(e) { showToast("Login Error: " + e.code); }
};

window.skipLogin = async () => {
    currentUser = { name: 'Guest', password: '' };
    showScreen('main-menu');
    document.getElementById('display-username').innerText = "Guest";
};

function loginSuccess(u, p, silent=false) {
    currentUser = { name: u, password: p };
    localStorage.setItem('ludo_user', JSON.stringify(currentUser));
    showScreen('main-menu');
    document.getElementById('display-username').innerText = u;
    document.getElementById('online-player-name').innerText = u;
    if(!silent) showToast(`Welcome ${u}`);
}
window.logout = () => { localStorage.removeItem('ludo_user'); localStorage.removeItem('ludo_current_room'); window.location.reload(); };

const boardEl = document.getElementById('board');
function createBoard() {
    MAIN_PATH.forEach((pos, idx) => {
        const c = document.createElement('div');
        c.className = 'cell'; c.style.gridRow = pos[0]; c.style.gridColumn = pos[1];
        if([1,14,27,40].includes(idx)) c.classList.add(`path-${COLORS[Math.floor(idx/13)]}`, 'start-point');
        if(SAFE_SPOTS.includes(idx)) c.classList.add('safe-spot');
        boardEl.appendChild(c);
    });
    Object.keys(HOME_PATHS).forEach(k => {
        const coords = HOME_PATHS[k];
        for(let i=0; i<coords.length; i++) {
            const c = document.createElement('div');
            c.className = `cell path-${k}`; c.style.gridRow = coords[i][0]; c.style.gridColumn = coords[i][1];
            boardEl.appendChild(c);
        }
    });
}
createBoard();

// --- WEBRTC LOGIC ---

// 1. Initialize Listener for incoming calls/answers
function initWebRTC() {
    if(signalUnsubscribe) signalUnsubscribe();
    
    // Listen for signals sent TO me
    const q = query(collection(db, 'ludo_rooms', roomId, 'signals'), where('to', '==', myPlayerId));
    signalUnsubscribe = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                await handleSignal(data);
                // Optionally delete signal after processing to keep DB clean, but not strictly required for simple demo
            }
        });
    });
}

// 2. Handle incoming signal
async function handleSignal(data) {
    const { from, type, signal } = data;
    
    if(!localStream) {
        // If I haven't turned on mic, I can't really "answer" with audio yet, 
        // but I can accept the remote audio.
        // For simplicity, we only connect if I also clicked Mic or if I auto-accept.
        // Let's assume we establish connection but I only send audio if my mic is on.
    }

    if (!peerConnections[from]) {
        createPeerConnection(from);
    }
    const pc = peerConnections[from];

    try {
        if (type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(signal));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await sendSignal(from, 'answer', answer);
        } else if (type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(signal));
        } else if (type === 'candidate') {
            await pc.addIceCandidate(new RTCIceCandidate(signal));
        }
    } catch(e) { console.error("WebRTC Error:", e); }
}

// 3. Create Peer Connection
function createPeerConnection(targetId) {
    const pc = new RTCPeerConnection(rtcConfig);
    peerConnections[targetId] = pc;

    // Add local tracks if available
    if(localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    // Handle ICE Candidates
    pc.onicecandidate = (event) => {
        if (event.candidate) {
            sendSignal(targetId, 'candidate', event.candidate);
        }
    };

    // Handle Remote Stream (Audio)
    pc.ontrack = (event) => {
        const remoteAudio = document.createElement('audio');
        remoteAudio.srcObject = event.streams[0];
        remoteAudio.autoplay = true;
        remoteAudio.id = `audio-${targetId}`;
        // Respect Speaker Toggle
        remoteAudio.muted = !isSpeakerOn;
        document.getElementById('remote-audio-container').appendChild(remoteAudio);
    };
    
    return pc;
}

// 4. Send Signal Helper
async function sendSignal(toId, type, signal) {
    // We add to the subcollection
    const col = collection(db, 'ludo_rooms', roomId, 'signals');
    await addDoc(col, {
        to: toId,
        from: myPlayerId,
        type: type,
        signal: JSON.parse(JSON.stringify(signal)), // Sanitize
        timestamp: serverTimestamp()
    });
}

// 5. Connect to all other players (Called when enabling mic)
async function connectToPeers() {
    const others = gameState.players.filter(p => p && p.id !== myPlayerId && p.status === 'active');
    
    for (const p of others) {
        if (!peerConnections[p.id]) {
            const pc = createPeerConnection(p.id);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await sendSignal(p.id, 'offer', offer);
        }
    }
}

// --- TOGGLE BUTTONS UPDATED ---

window.toggleMic = async () => {
    const btn = document.getElementById('btn-mic');
    const icon = btn.querySelector('i');
    
    if(!isMicOn) {
        // TURN ON
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            isMicOn = true;
            icon.className = 'fas fa-microphone text-green-500';
            showToast("Mic On - Connecting...");
            
            // Initiate calls to existing peers
            await connectToPeers();
            
            // Add track to existing connections (if any existed before mic access)
            Object.values(peerConnections).forEach(pc => {
                localStream.getTracks().forEach(track => {
                    // Check if sender already exists
                    const senders = pc.getSenders();
                    const hasTrack = senders.some(s => s.track === track);
                    if(!hasTrack) pc.addTrack(track, localStream);
                });
            });

        } catch(e) { 
            console.error(e);
            showToast("Mic Denied or Not HTTPS"); 
        }
    } else {
        // TURN OFF
        if(localStream) {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
        }
        isMicOn = false;
        icon.className = 'fas fa-microphone-slash text-slate-500';
        showToast("Mic Off");
        // We don't close PC, just stop sending audio.
    }
};

window.toggleSpeaker = () => {
    const btn = document.getElementById('btn-speaker');
    const icon = btn.querySelector('i');
    isSpeakerOn = !isSpeakerOn;
    
    if(!isSpeakerOn) {
        icon.className = 'fas fa-volume-mute text-red-400';
        showToast("Audio Muted");
    } else {
        icon.className = 'fas fa-volume-up text-slate-500';
        showToast("Audio On");
    }
    
    // Update all remote audio elements
    document.querySelectorAll('audio').forEach(el => el.muted = !isSpeakerOn);
};


// --- MULTIPLAYER LOGIC ---
function enterLobby(code) {
    showScreen('lobby-waiting');
    document.getElementById('display-room-code').innerText = code;
    localStorage.setItem('ludo_current_room', code);

    roomUnsubscribe = onSnapshot(doc(db, 'ludo_rooms', code), sn => {
        const d = sn.data();
        if(!d) return;
        
        if(d.chat && d.chat.length > gameState.chatCount) {
             handleChatUpdates(d.chat);
        }

        if(d.status === 'LOBBY') {
            const list = document.getElementById('lobby-players');
            const activeP = d.players.filter(p => p.status !== 'left');
            list.innerHTML = activeP.map(p => `<div class="p-3 bg-white rounded-xl shadow-sm text-sm border-l-4 border-${COLORS[p.color]}-500 font-bold flex justify-between"><span>${p.name}</span> <span class="text-xs text-slate-400 self-center">${COLORS[p.color].toUpperCase()}</span></div>`).join('');
            if(d.host === myPlayerId && activeP.length > 1) document.getElementById('start-online-btn').classList.remove('hidden');
        } else if(d.status === 'PLAYING') {
            if(gameState.mode !== 'online') startOnline(d); else syncState(d);
        }
    });
    
    // Start Listening for Audio Signals
    initWebRTC();
}

function startOnline(d) {
    gameState.mode = 'online'; 
    gameState.players = [null, null, null, null];
    d.players.forEach(p => {
        if(p.color >= 0 && p.color < 4) gameState.players[p.color] = p;
    });
    showScreen('game-ui');
    syncState(d);
}

function syncState(d) {
    gameState.turn = d.turn; 
    gameState.diceValue = d.diceValue; 
    gameState.waitingForMove = d.waitingForMove;
    gameState.pieces = JSON.parse(d.pieces); 
    
    d.players.forEach(p => {
        if(gameState.players[p.color]) gameState.players[p.color].status = p.status;
    });

    updateUI(); 
    renderPieces(); 
    checkActivePlayers();
}

function handleChatUpdates(messages) {
    const newCount = messages.length;
    if (newCount > gameState.chatCount) {
        messages.slice(gameState.chatCount).forEach(msg => spawnFloatingBubble(msg));
        gameState.chatCount = newCount;
    }
}

function spawnFloatingBubble(msg) {
    const container = document.getElementById('floating-chat-container');
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble-float';
    bubble.innerHTML = `<strong>${msg.name}:</strong> ${msg.text}`;
    container.appendChild(bubble);
    setTimeout(() => bubble.remove(), 7000);
}

window.createRoom = async () => {
    if(!auth.currentUser) { showToast("Auth Error"); return; }
    const name = currentUser.name || 'Host';
    const code = Math.random().toString(36).substr(2,6).toUpperCase();
    try {
        myPlayerId = auth.currentUser.uid; roomId = code;
        const initialPieces = JSON.stringify(Array(4).fill(0).map(() => Array(4).fill(0).map(() => ({s:'BASE', p:0}))));
        await setDoc(doc(db, 'ludo_rooms', code), {
            status: 'LOBBY', host: myPlayerId, chat: [], 
            players: [{id:myPlayerId, name: name, color:0, type:'remote', status:'active'}], 
            pieces: initialPieces, turn: 0, diceValue: 0, waitingForMove: false, lastUpdated: serverTimestamp()
        });
        enterLobby(code);
    } catch(e) { showToast("Error: " + e.message); }
};

window.joinRoom = async () => {
    if(!auth.currentUser) await signInAnonymously(auth);
    const code = document.getElementById('room-code-input').value.toUpperCase();
    const name = currentUser.name || 'Guest';
    try {
        const ref = doc(db, 'ludo_rooms', code);
        const d = await getDoc(ref);
        if(!d.exists()) return showToast("Room not found");
        const players = d.data().players;
        const activePlayers = players.filter(p => p.status !== 'left');
        
        if(activePlayers.length >= 4) return showToast("Room Full");
        
        myPlayerId = auth.currentUser.uid; roomId = code;
        
        if(!players.some(p => p.id === myPlayerId)) {
            const takenColors = players.filter(p => p.status!=='left').map(p => p.color);
            let newColor = 0;
            if(activePlayers.length === 1) {
                const hostColor = activePlayers[0].color;
                newColor = (hostColor + 2) % 4;
            } else {
                while(takenColors.includes(newColor)) newColor++;
            }
            await updateDoc(ref, { players: [...players, {id:myPlayerId, name: name, color:newColor, type:'remote', status:'active'}] });
        }
        enterLobby(code);
    } catch(e) { showToast("Join Failed"); console.error(e); }
};

window.startOnlineGame = () => updateDoc(doc(db, 'ludo_rooms', roomId), { status: 'PLAYING' });

function pushGameState() {
    updateDoc(doc(db, 'ludo_rooms', roomId), {
        turn: gameState.turn, diceValue: gameState.diceValue, waitingForMove: gameState.waitingForMove, pieces: JSON.stringify(gameState.pieces), lastUpdated: serverTimestamp()
    });
}

window.startGame = (mode) => {
    gameState = {
        mode, turn: 0, diceValue: 0, waitingForMove: false, isProcessing: false, winners: [], chatCount: 0,
        pieces: Array(4).fill(0).map(() => Array(4).fill(0).map(() => ({s:'BASE', p:0}))),
        players: mode === 'local' 
            ? [{id:'p1',name:currentUser.name||'You',color:0,type:'human', status:'active'}, null, {id:'bot',name:'CPU',color:2,type:'bot', status:'active'}, null] 
            : []
    };
    showScreen('game-ui');
    updateUI();
    setTimeout(renderPieces, 50);
};

function updateUI() {
    const p = gameState.players[gameState.turn];
    const color = COLORS[gameState.turn];
    if(p && p.status === 'active') {
        document.getElementById('turn-text').innerText = `${p.name}'s Turn`;
        document.getElementById('turn-text').style.color = color === 'yellow' ? '#d97706' : '#334155';
        document.getElementById('current-turn-indicator').className = `w-3 h-3 rounded-full bg-${color === 'yellow' ? 'yellow-500' : color + '-500'}`;
    } else {
         document.getElementById('turn-text').innerText = `Waiting...`;
    }
    const diceBox = document.getElementById('dice-visual');
    if(gameState.diceValue === 0) diceBox.innerHTML = '<i class="fas fa-dice-six"></i>';
    else diceBox.innerHTML = `<i class="fas fa-dice-${['one','two','three','four','five','six'][gameState.diceValue-1]}"></i>`;
    diceBox.className = `dice-box dice-${color}`;
    
    [0,1,2,3].forEach(i => {
        const lbl = document.getElementById(`name-${i}`);
        const base = document.getElementById(`base-${i}`);
        const player = gameState.players[i];
        if(player) {
            lbl.innerText = player.name.substring(0,8); 
            lbl.style.display = 'block';
            if(player.status === 'left') {
                base.classList.add('left-game');
                lbl.innerText += " (Left)";
                lbl.style.opacity = 0.5;
            } else {
                base.classList.remove('left-game');
                lbl.style.opacity = 1;
            }
        } else {
            lbl.style.display = 'none';
        }
    });
}

function renderPieces() {
    const cellCounts = {}; 
    gameState.pieces.forEach((pArr, pIdx) => {
        if(!gameState.players[pIdx] || gameState.players[pIdx].status === 'left') return; 
        pArr.forEach((piece, tIdx) => {
            let r, c;
            if(piece.s === 'WIN') [r,c] = WIN_POSITIONS[COLORS[pIdx]];
            else if(piece.s === 'BASE') [r,c] = BASE_POSITIONS[COLORS[pIdx]][tIdx];
            else if(piece.s === 'PATH') {
                const startIdx = START_INDICES[COLORS[pIdx]];
                const globalIdx = (startIdx + piece.p) % 52;
                [r,c] = MAIN_PATH[globalIdx];
            } else if(piece.s === 'HOME') {
                [r,c] = HOME_PATHS[COLORS[pIdx]][piece.p];
            }
            const key = `${r},${c}`;
            cellCounts[key] = (cellCounts[key] || 0) + 1;
            const stack = cellCounts[key];
            const id = `token-${pIdx}-${tIdx}`;
            let el = document.getElementById(id);
            if(!el) {
                el = document.createElement('div'); el.id = id; el.className = `token token-${COLORS[pIdx]}`; el.innerHTML = PAWN_SVG;
                el.onclick = (e) => { e.stopPropagation(); if(isCurrentPlayerTurn()) handleTokenClick(pIdx, tIdx); };
                boardEl.appendChild(el);
            }
            el.style.gridRow = r; el.style.gridColumn = c;
            el.classList.remove('stack-1', 'stack-2', 'stack-3', 'stack-4', 'win-stack-1', 'win-stack-2', 'win-stack-3', 'win-stack-4', 'highlight-move', 'moveable');
            if(piece.s === 'WIN') { if(stack > 0) el.classList.add(`win-stack-${Math.min(stack,4)}`); }
            else { if(stack > 1) el.classList.add(`stack-${Math.min(stack,4)}`); }
            
            if(gameState.waitingForMove && !gameState.isProcessing && isCurrentPlayerTurn() && canMove(pIdx, tIdx, gameState.diceValue)) {
                el.classList.add('highlight-move', 'moveable');
            }
        });
    });
}

function attemptRoll() {
    if(!isCurrentPlayerTurn() || gameState.isProcessing || gameState.waitingForMove) return;
    performRoll(true);
}

function performRoll(isHuman) {
    gameState.isProcessing = true;
    const dice = document.getElementById('dice-visual');
    dice.classList.add('dice-rolling');
    if (audioCtx.state === 'suspended') audioCtx.resume();
    playSound('roll');
    const faces = ['one','two','three','four','five','six'];
    const interval = setInterval(() => { 
        dice.innerHTML = `<i class="fas fa-dice-${faces[Math.floor(Math.random()*6)]}"></i>`; 
        dice.style.transform = `rotate(${Math.random()*30 - 15}deg)`;
    }, 50);
    const result = Math.floor(Math.random()*6)+1;
    setTimeout(() => { clearInterval(interval); dice.style.transform = ''; dice.classList.remove('dice-rolling'); handleRollResult(result); }, 600);
}

function handleRollResult(roll) {
    gameState.diceValue = roll;
    if(gameState.mode === 'online') { gameState.isProcessing = false; pushGameState(); }
    else updateUI();
    const moves = getPossibleMoves(gameState.turn, roll);
    if(moves.length === 0) setTimeout(nextTurn, 1000);
    else {
        if(moves.length === 1 && isCurrentPlayerTurn() && gameState.players[gameState.turn].type !== 'bot') {
            gameState.waitingForMove = true; renderPieces();
            setTimeout(() => executeMove(gameState.turn, moves[0]), 500);
        } else {
            gameState.waitingForMove = true; gameState.isProcessing = false; renderPieces();
        }
        if(gameState.mode === 'local' && gameState.players[gameState.turn].type === 'bot') setTimeout(playBotTurn, 800);
        if(gameState.mode === 'online') pushGameState();
    }
}

function canMove(pIdx, tIdx, roll) {
    if(gameState.turn !== pIdx) return false;
    const p = gameState.pieces[pIdx][tIdx];
    if(p.s === 'WIN') return false; 
    if(p.s === 'BASE') return roll === 6;
    if(p.s === 'PATH') return p.p + roll <= 55; 
    if(p.s === 'HOME') return p.p + roll <= 5;
    return false;
}

function getPossibleMoves(pIdx, roll) {
    return gameState.pieces[pIdx].map((_, i) => i).filter(i => canMove(pIdx, i, roll));
}

async function handleTokenClick(pIdx, tIdx) {
    if(!gameState.waitingForMove || gameState.isProcessing) return;
    if(!canMove(pIdx, tIdx, gameState.diceValue)) return;
    executeMove(pIdx, tIdx);
}

async function executeMove(pIdx, tIdx) {
    gameState.isProcessing = true;
    document.querySelectorAll('.token').forEach(t => t.classList.remove('highlight-move'));
    const p = gameState.pieces[pIdx][tIdx];
    if(p.s === 'BASE') { p.s = 'PATH'; p.p = 0; renderPieces(); playSound('move'); } 
    else {
        const steps = gameState.diceValue;
        for(let i=0; i<steps; i++) {
            if(p.s === 'PATH') { p.p++; if(p.p > 50) { p.s = 'HOME'; p.p -= 51; } } 
            else if(p.s === 'HOME') { p.p++; if(p.p === 5) p.s = 'WIN'; }
            renderPieces(); playSound('move'); await new Promise(r => setTimeout(r, 200));
        }
    }
    let bonusTurn = false;
    if(p.s === 'PATH') {
        const startIdx = START_INDICES[COLORS[pIdx]];
        const myGlob = (startIdx + p.p) % 52;
        const allSafe = [1, 14, 27, 40, ...SAFE_SPOTS];
        if(!allSafe.includes(myGlob)) {
            gameState.pieces.forEach((opps, oIdx) => {
                if(oIdx !== pIdx && gameState.players[oIdx] && gameState.players[oIdx].status === 'active') opps.forEach(op => {
                    const opStart = START_INDICES[COLORS[oIdx]];
                    if(op.s === 'PATH' && (opStart + op.p)%52 === myGlob) { 
                        op.s = 'BASE'; op.p = 0; showToast("Captured!"); playSound('win'); bonusTurn = true;
                    }
                });
            });
        }
    }
    if(p.s === 'WIN') { checkWin(pIdx); renderPieces(); playSound('win'); showToast("Home!"); bonusTurn = true; }
    
    gameState.waitingForMove = false;
    if((gameState.diceValue === 6 || bonusTurn) && gameState.winners.length === 0) {
        gameState.diceValue = 0; showToast("Bonus Turn!"); gameState.isProcessing = false;
        if(gameState.mode === 'online') pushGameState();
        else { 
            updateUI(); renderPieces(); 
            if(gameState.mode === 'local' && gameState.players[gameState.turn].type === 'bot') setTimeout(() => performRoll(false), 1000);
        }
    } else nextTurn();
}

function nextTurn() {
    gameState.diceValue = 0; gameState.waitingForMove = false; gameState.isProcessing = false;
    let loops = 0;
    do { 
        gameState.turn = (gameState.turn + 1) % 4; 
        loops++; 
    } while((!gameState.players[gameState.turn] || gameState.players[gameState.turn].status === 'left' || gameState.winners.includes(gameState.turn)) && loops < 4);
    checkActivePlayers();
    if(gameState.mode === 'online') pushGameState();
    else { 
        updateUI(); renderPieces(); playSound('turn');
        if(gameState.mode === 'local' && gameState.players[gameState.turn].type === 'bot') setTimeout(() => performRoll(false), 1000); 
    }
}

function checkActivePlayers() {
    if(gameState.mode !== 'online') return;
    const active = gameState.players.filter(p => p && p.status === 'active');
    if(active.length === 1 && gameState.players.filter(p => p).length > 1) {
        const winner = active[0];
        document.getElementById('winner-name').innerText = `${winner.name} Wins!`;
        document.getElementById('winner-name').innerHTML += `<div class="text-sm text-slate-400 mt-2">Others left the game</div>`;
        document.getElementById('victory-modal').classList.remove('hidden');
    }
}

function playBotTurn() {
    const moves = getPossibleMoves(gameState.turn, gameState.diceValue);
    if(moves.length > 0) {
        let bestMove = moves[0];
        let maxScore = -1000;
        moves.forEach(mIdx => {
            const score = evaluateMoveScore(gameState.turn, mIdx, gameState.diceValue);
            if(score > maxScore) { maxScore = score; bestMove = mIdx; }
        });
        executeMove(gameState.turn, bestMove);
    } 
}

function evaluateMoveScore(pIdx, tIdx, roll) {
    let score = 0;
    const p = gameState.pieces[pIdx][tIdx];
    if(p.s === 'BASE') return 35;
    let nextP = p.p + roll;
    let isHome = false, isWin = false;
    if(p.s === 'PATH' && nextP > 50) { isHome = true; nextP -= 51; } else if(p.s === 'HOME') { if(nextP === 5) isWin = true; }
    if(isWin) return 1000; if(isHome) return 50;
    const startIdx = START_INDICES[COLORS[pIdx]];
    const targetGlob = (startIdx + nextP) % 52;
    const allSafe = [1, 14, 27, 40, ...SAFE_SPOTS];
    if(!allSafe.includes(targetGlob)) {
        let capture = false;
        gameState.pieces.forEach((opps, oIdx) => {
            if(oIdx !== pIdx && gameState.players[oIdx] && gameState.players[oIdx].status === 'active') opps.forEach(op => {
                const opStart = START_INDICES[COLORS[oIdx]];
                if(op.s === 'PATH' && (opStart + op.p)%52 === targetGlob) capture = true;
            });
        });
        if(capture) score += 100;
    }
    if(allSafe.includes(targetGlob)) score += 20;
    score += (roll * 2);
    return score;
}

function isCurrentPlayerTurn() {
    if(gameState.mode === 'local') return gameState.players[gameState.turn]?.type === 'human';
    return gameState.players[gameState.turn]?.id === myPlayerId;
}

function checkWin(pIdx) {
    if(gameState.pieces[pIdx].every(p => p.s === 'WIN')) {
        gameState.winners.push(pIdx); document.getElementById('winner-name').innerText = `${gameState.players[pIdx].name} Wins!`;
        document.getElementById('victory-modal').classList.remove('hidden');
    }
}

function showToast(msg) {
    const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0'); t.classList.remove('translate-y-4');
    setTimeout(() => { t.classList.add('opacity-0'); t.classList.add('translate-y-4'); }, 2000);
}

window.showGiveUp = () => document.getElementById('give-up-modal').classList.remove('hidden');

window.confirmGiveUp = async () => { 
    document.getElementById('give-up-modal').classList.add('hidden'); 
    localStorage.removeItem('ludo_current_room');
    
    if(gameState.mode === 'online' && roomId && myPlayerId) {
         try {
             const ref = doc(db, 'ludo_rooms', roomId);
             const d = await getDoc(ref);
             if(d.exists()) {
                 const plList = d.data().players;
                 const myIdx = plList.findIndex(p => p.id === myPlayerId);
                 if(myIdx !== -1) {
                     plList[myIdx].status = 'left';
                     await updateDoc(ref, {
                        players: plList,
                        chat: arrayUnion({name: 'System', color: -1, text: `${plList[myIdx].name} left the game.`})
                     });
                 }
             }
         } catch(e) { console.log(e); }
    }
    
    showToast("You left the game"); 
    setTimeout(() => window.exitGame(), 500); 
};

window.sendChat = async () => {
    const input = document.getElementById('chat-input');
    const txt = input.value.trim();
    if(!txt) return;
    input.value = ''; 
    
    if(gameState.mode === 'local') { 
        renderChat([{name: currentUser.name || 'You', color: 0, text: txt}]); 
        return; 
    }
    
    if(!roomId) return;
    const p = gameState.players.find(pl => pl?.id === myPlayerId);
    
    // We do NOT optimistic render here anymore to avoid double messages. 
    // We wait for the DB subscription to trigger the render.
    await updateDoc(doc(db, 'ludo_rooms', roomId), { chat: arrayUnion({name: p ? p.name : 'User', color: p ? p.color : -1, text: txt}) });
};
window.handleChatKey = (e) => { if(e.key === 'Enter') window.sendChat(); }

function renderChat(messages) {
    if (!messages) return;
    const newCount = messages.length;
    if (newCount > gameState.chatCount) {
        messages.slice(gameState.chatCount).forEach(msg => spawnFloatingBubble(msg));
        gameState.chatCount = newCount;
    }
}

window.copyRoomLink = () => {
    const url = window.location.origin + window.location.pathname + '?room=' + roomId;
    navigator.clipboard.writeText(url).then(() => showToast("Link Copied!"));
};
window.exitGame = async () => {
    localStorage.removeItem('ludo_current_room');
    if (roomUnsubscribe) roomUnsubscribe();
    if (signalUnsubscribe) signalUnsubscribe();
    gameState.mode = null;
    showScreen('main-menu');
    
    // Close Audio Connections
    if(localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
    }
    Object.values(peerConnections).forEach(pc => pc.close());
    peerConnections = {};
    isMicOn = false;
    document.querySelector('#btn-mic i').className = 'fas fa-microphone-slash text-slate-500';
    document.querySelectorAll('.token').forEach(el => el.remove());
};
window.attemptRoll = attemptRoll;
window.showOnlineMenu = () => showScreen('online-menu');
window.backToMain = () => showScreen('main-menu');

// --- OTHER UTILS ---
window.toggleMic = window.toggleMic; // (Defined above)
window.toggleSpeaker = window.toggleSpeaker; // (Defined above)

</script>
</body>
</html>